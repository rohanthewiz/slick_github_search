<h3 class="page-title">Search Github Repositories</h3>

<!--GET /search/repositories-->
<!--https://api.github.com/search/repositories?q=tetris+language:assembly&sort=stars&order=desc-->
<%
  if @results && @client.last_response.rels.present?
    total_count = @results.total_count
    last_response = @client.last_response
    number_of_pages = 1
    if last_response.rels[:last].present?
      number_of_pages = page_from_href(last_response.rels[:last])
    elsif last_response.rels[:prev].present?
      number_of_pages = page_from_href(last_response.rels[:prev]) + 1
    end

    current_page = 1
    if last_response.rels[:next].present?
      current_page = page_from_href(last_response.rels[:next]) - 1
    elsif last_response.rels[:prev].present?
      current_page = page_from_href(last_response.rels[:prev]) + 1
    end
%>
  <%= render partial: 'pagination',
         locals: {total_count: total_count,
                  number_of_pages: number_of_pages,
                  current_page: current_page}
  %>

<% end %>

<%= form_tag(pages_search_path, method: :get, id: 'pagination-form') do %>
  <%= label_tag 'search_term' %>
  <%= text_field_tag 'search_term', @search_term %>
  <%= hidden_field_tag('page') %>
  <%= label_tag 'language_filter' %>
  <%= text_field_tag 'language_filter', @language_filter %>
  <%= submit_tag 'Search Repos' %>
<% end %>

<table id="results-list">
  <thead><tr><th>Name</th><th>Owner</th><th>Stars</th>
  <th>Forks</th><th>Language</th>
    <th>Description</th></tr></thead>
  <% @results&.items&.each do |row| %>
    <tr><td><%= row[:name] %></td><td><%= row[:owner][:login] %></td>
      <td><%= row[:stargazers_count] %></td>
      <td><%= row[:forks_count] %></td>
      <td><%= row[:language] %></td>
      <td><%= truncate(row[:description], length: 200) %></td>
    </tr>
  <% end %>
</table>

<script type="text/javascript">
  $(document).ready(function(){
    $('.page-number').on('click', function() {
      $('#page').val(this.innerText);
      $('#pagination-form').submit();
    })
  });
</script>